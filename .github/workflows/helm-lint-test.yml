name: Helm Chart Lint & Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: Lint Helm Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.16.1'

      - name: Verify Helm installation
        run: |
          helm version

      - name: Lint Helm chart
        run: |
          helm lint charts/mongodb-operator/

      - name: Check for required fields
        run: |
          echo "Checking Chart.yaml for required fields..."
          if ! grep -q "apiVersion:" charts/mongodb-operator/Chart.yaml; then
            echo "ERROR: apiVersion field missing from Chart.yaml"
            exit 1
          fi
          if ! grep -q "name:" charts/mongodb-operator/Chart.yaml; then
            echo "ERROR: name field missing from Chart.yaml"
            exit 1
          fi
          if ! grep -q "version:" charts/mongodb-operator/Chart.yaml; then
            echo "ERROR: version field missing from Chart.yaml"
            exit 1
          fi
          echo "All required fields present in Chart.yaml"

      - name: Validate values.yaml syntax
        run: |
          echo "Validating values.yaml syntax..."
          if ! yamllint --strict charts/mongodb-operator/values.yaml; then
            echo "values.yaml has YAML syntax issues"
            exit 1
          fi
        continue-on-error: false

  test:
    name: Test Helm Chart Templates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        values-file:
          - charts/mongodb-operator/values.yaml
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.16.1'

      - name: Verify Helm installation
        run: |
          helm version

      - name: Template chart with default values
        run: |
          helm template test-release charts/mongodb-operator/ --debug > /tmp/default-render.yaml
          echo "Default values render successful"
          wc -l /tmp/default-render.yaml

      - name: Template chart with minimal values
        run: |
          cat > /tmp/minimal-values.yaml <<EOF
          replicaCount: 1
          rbac:
            create: false
          metrics:
            enabled: false
          EOF
          helm template test-release charts/mongodb-operator/ -f /tmp/minimal-values.yaml --debug > /tmp/minimal-render.yaml
          echo "Minimal values render successful"
          wc -l /tmp/minimal-render.yaml

      - name: Template chart with production values
        run: |
          cat > /tmp/production-values.yaml <<EOF
          replicaCount: 3
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          metrics:
            enabled: true
            serviceMonitor:
              enabled: true
          nodeSelector:
            kubernetes.io/os: linux
          tolerations:
            - key: "node-role.kubernetes.io/master"
              operator: "Exists"
              effect: "NoSchedule"
          EOF
          helm template test-release charts/mongodb-operator/ -f /tmp/production-values.yaml --debug > /tmp/production-render.yaml
          echo "Production values render successful"
          wc -l /tmp/production-render.yaml

      - name: Validate rendered Kubernetes manifests
        run: |
          echo "Validating rendered manifests..."
          if ! kubectl version --client > /dev/null 2>&1; then
            echo "Installing kubectl..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          kubectl apply --dry-run=server -f /tmp/default-render.yaml || echo "Server validation skipped (no cluster access)"

      - name: Check for deprecated APIs in rendered output
        run: |
          echo "Checking for deprecated Kubernetes APIs..."
          if grep -q "extensions/v1beta1" /tmp/default-render.yaml; then
            echo "ERROR: Found deprecated extensions/v1beta1 API"
            exit 1
          fi
          if grep -q "apps/v1beta2" /tmp/default-render.yaml; then
            echo "ERROR: Found deprecated apps/v1beta2 API"
            exit 1
          fi
          if grep -q "batch/v1beta1" /tmp/default-render.yaml; then
            echo "ERROR: Found deprecated batch/v1beta1 API"
            exit 1
          fi
          echo "No deprecated APIs found"

  package:
    name: Package Helm Chart
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.16.1'

      - name: Verify Helm installation
        run: |
          helm version

      - name: Package Helm chart
        run: |
          helm package charts/mongodb-operator/ --destination /tmp/helm-packages/

      - name: Verify package created
        run: |
          echo "Verifying Helm package creation..."
          ls -lh /tmp/helm-packages/
          if [ ! -f /tmp/helm-packages/mongodb-operator-*.tgz ]; then
            echo "ERROR: Helm package not created"
            exit 1
          fi
          echo "Helm package created successfully"

      - name: Upload Helm package artifact
        uses: actions/upload-artifact@v4
        with:
          name: helm-package
          path: /tmp/helm-packages/*.tgz
          retention-days: 30

      - name: Verify package integrity
        run: |
          echo "Verifying package integrity..."
          PACKAGE_FILE=$(ls /tmp/helm-packages/mongodb-operator-*.tgz)
          echo "Testing package: $PACKAGE_FILE"
          helm lint "$PACKAGE_FILE"
          echo "Package integrity verified"

      - name: Extract and verify package contents
        run: |
          echo "Extracting package for verification..."
          PACKAGE_FILE=$(ls /tmp/helm-packages/mongodb-operator-*.tgz)
          mkdir -p /tmp/extracted-chart
          tar -xzf "$PACKAGE_FILE" -C /tmp/extracted-chart/
          echo "Package contents:"
          ls -lh /tmp/extracted-chart/
          if [ ! -f /tmp/extracted-chart/Chart.yaml ]; then
            echo "ERROR: Chart.yaml missing from package"
            exit 1
          fi
          if [ ! -f /tmp/extracted-chart/values.yaml ]; then
            echo "ERROR: values.yaml missing from package"
            exit 1
          fi
          echo "All required files present in package"
