---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: mongodbshardeds.mongodb.keiailab.com
spec:
  group: mongodb.keiailab.com
  names:
    kind: MongoDBSharded
    listKind: MongoDBShardedList
    plural: mongodbshardeds
    shortNames:
      - mdbsh
    singular: mongodbsharded
  scope: Namespaced
  versions:
    - additionalPrinterColumns:
        - jsonPath: .status.phase
          name: Phase
          type: string
        - jsonPath: .spec.shards.count
          name: Shards
          type: integer
        - jsonPath: .status.mongos.ready
          name: Mongos
          type: integer
        - jsonPath: .spec.version.version
          name: Version
          type: string
        - jsonPath: .metadata.creationTimestamp
          name: Age
          type: date
      name: v1alpha1
      schema:
        openAPIV3Schema:
          description: MongoDBSharded is the Schema for the mongodbshardeds API
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              properties:
                additionalConfig:
                  additionalProperties:
                    type: string
                  type: object
                auth:
                  properties:
                    adminCredentialsSecretRef:
                      properties:
                        name:
                          type: string
                      type: object
                    mechanism:
                      default: SCRAM-SHA-256
                      enum:
                        - SCRAM-SHA-256
                        - SCRAM-SHA-1
                        - X509
                      type: string
                    users:
                      items:
                        properties:
                          db:
                            type: string
                          name:
                            type: string
                          passwordSecretRef:
                            properties:
                              key:
                                type: string
                              name:
                                type: string
                            required:
                              - key
                            type: object
                          roles:
                            items:
                              properties:
                                db:
                                  type: string
                                name:
                                  type: string
                              required:
                                - db
                                - name
                              type: object
                            type: array
                        required:
                          - db
                          - name
                          - passwordSecretRef
                          - roles
                        type: object
                      type: array
                  required:
                    - adminCredentialsSecretRef
                  type: object
                backup:
                  properties:
                    enabled:
                      type: boolean
                    oplogRetentionHours:
                      default: 24
                      type: integer
                    pitrEnabled:
                      default: false
                      type: boolean
                    retention:
                      properties:
                        count:
                          type: integer
                        days:
                          default: 7
                          type: integer
                      type: object
                    schedule:
                      type: string
                    storage:
                      properties:
                        pvc:
                          properties:
                            size:
                              anyOf:
                                - type: integer
                                - type: string
                              x-kubernetes-int-or-string: true
                            storageClassName:
                              type: string
                          required:
                            - size
                          type: object
                        s3:
                          properties:
                            bucket:
                              type: string
                            credentialsRef:
                              properties:
                                name:
                                  type: string
                              type: object
                            endpoint:
                              type: string
                            insecureSkipTLS:
                              type: boolean
                            prefix:
                              type: string
                            region:
                              type: string
                          required:
                            - bucket
                            - credentialsRef
                          type: object
                        type:
                          enum:
                            - s3
                            - pvc
                          type: string
                      required:
                        - type
                      type: object
                  required:
                    - enabled
                    - storage
                  type: object
                configServer:
                  properties:
                    members:
                      default: 3
                      enum:
                        - 1
                        - 3
                      format: int32
                      type: integer
                    pod:
                      x-kubernetes-preserve-unknown-fields: true
                    resources:
                      properties:
                        limits:
                          additionalProperties:
                            anyOf:
                              - type: integer
                              - type: string
                            x-kubernetes-int-or-string: true
                          type: object
                        requests:
                          additionalProperties:
                            anyOf:
                              - type: integer
                              - type: string
                            x-kubernetes-int-or-string: true
                          type: object
                      type: object
                    storage:
                      properties:
                        dataDirPath:
                          default: /data/db
                          type: string
                        size:
                          anyOf:
                            - type: integer
                            - type: string
                          default: 10Gi
                          x-kubernetes-int-or-string: true
                        storageClassName:
                          default: ceph-block
                          type: string
                      type: object
                  type: object
                mongos:
                  properties:
                    autoScaling:
                      properties:
                        enabled:
                          type: boolean
                        maxReplicas:
                          format: int32
                          type: integer
                        metrics:
                          items:
                            properties:
                              customMetric:
                                properties:
                                  name:
                                    type: string
                                  query:
                                    type: string
                                required:
                                  - name
                                type: object
                              target:
                                format: int32
                                type: integer
                              type:
                                enum:
                                  - cpu
                                  - memory
                                  - custom
                                type: string
                            required:
                              - target
                              - type
                            type: object
                          type: array
                        minReplicas:
                          format: int32
                          minimum: 1
                          type: integer
                      required:
                        - enabled
                        - maxReplicas
                      type: object
                    pod:
                      x-kubernetes-preserve-unknown-fields: true
                    replicas:
                      default: 2
                      format: int32
                      minimum: 1
                      type: integer
                    resources:
                      properties:
                        limits:
                          additionalProperties:
                            anyOf:
                              - type: integer
                              - type: string
                            x-kubernetes-int-or-string: true
                          type: object
                        requests:
                          additionalProperties:
                            anyOf:
                              - type: integer
                              - type: string
                            x-kubernetes-int-or-string: true
                          type: object
                      type: object
                    service:
                      properties:
                        annotations:
                          additionalProperties:
                            type: string
                          type: object
                        loadBalancerIP:
                          type: string
                        port:
                          default: 27017
                          format: int32
                          type: integer
                        type:
                          default: ClusterIP
                          enum:
                            - ClusterIP
                            - NodePort
                            - LoadBalancer
                          type: string
                      type: object
                  type: object
                monitoring:
                  properties:
                    enabled:
                      default: true
                      type: boolean
                    exporter:
                      properties:
                        image:
                          default: percona/mongodb_exporter:0.40
                          type: string
                        resources:
                          x-kubernetes-preserve-unknown-fields: true
                      type: object
                    prometheusRules:
                      properties:
                        enabled:
                          type: boolean
                        labels:
                          additionalProperties:
                            type: string
                          type: object
                      required:
                        - enabled
                      type: object
                    serviceMonitor:
                      properties:
                        interval:
                          default: 30s
                          type: string
                        labels:
                          additionalProperties:
                            type: string
                          type: object
                        namespace:
                          type: string
                      type: object
                  required:
                    - enabled
                  type: object
                shards:
                  properties:
                    autoScaling:
                      properties:
                        enabled:
                          type: boolean
                        maxShards:
                          format: int32
                          type: integer
                        metrics:
                          items:
                            properties:
                              customMetric:
                                properties:
                                  name:
                                    type: string
                                  query:
                                    type: string
                                required:
                                  - name
                                type: object
                              target:
                                format: int32
                                type: integer
                              type:
                                type: string
                            required:
                              - target
                              - type
                            type: object
                          type: array
                        minShards:
                          format: int32
                          type: integer
                      required:
                        - enabled
                        - maxShards
                      type: object
                    count:
                      default: 2
                      format: int32
                      minimum: 1
                      type: integer
                    membersPerShard:
                      default: 3
                      format: int32
                      minimum: 1
                      type: integer
                    pod:
                      x-kubernetes-preserve-unknown-fields: true
                    resources:
                      properties:
                        limits:
                          additionalProperties:
                            anyOf:
                              - type: integer
                              - type: string
                            x-kubernetes-int-or-string: true
                          type: object
                        requests:
                          additionalProperties:
                            anyOf:
                              - type: integer
                              - type: string
                            x-kubernetes-int-or-string: true
                          type: object
                      type: object
                    storage:
                      properties:
                        dataDirPath:
                          default: /data/db
                          type: string
                        size:
                          anyOf:
                            - type: integer
                            - type: string
                          default: 10Gi
                          x-kubernetes-int-or-string: true
                        storageClassName:
                          default: ceph-block
                          type: string
                      type: object
                  type: object
                tls:
                  properties:
                    certManager:
                      properties:
                        duration:
                          default: 2160h
                          type: string
                        issuerRef:
                          properties:
                            kind:
                              default: ClusterIssuer
                              enum:
                                - Issuer
                                - ClusterIssuer
                              type: string
                            name:
                              type: string
                          required:
                            - name
                          type: object
                        renewBefore:
                          default: 360h
                          type: string
                      required:
                        - issuerRef
                      type: object
                    customCert:
                      properties:
                        secretName:
                          type: string
                      required:
                        - secretName
                      type: object
                    enabled:
                      default: true
                      type: boolean
                  required:
                    - enabled
                  type: object
                version:
                  properties:
                    image:
                      type: string
                    version:
                      pattern: ^\d+\.\d+(\.\d+)?$
                      type: string
                  required:
                    - version
                  type: object
              required:
                - auth
                - configServer
                - mongos
                - shards
                - version
              type: object
            status:
              properties:
                conditions:
                  items:
                    properties:
                      lastTransitionTime:
                        format: date-time
                        type: string
                      message:
                        type: string
                      reason:
                        type: string
                      status:
                        enum:
                          - "True"
                          - "False"
                          - Unknown
                        type: string
                      type:
                        type: string
                    required:
                      - lastTransitionTime
                      - message
                      - reason
                      - status
                      - type
                    type: object
                  type: array
                configServer:
                  properties:
                    phase:
                      type: string
                    ready:
                      format: int32
                      type: integer
                    total:
                      format: int32
                      type: integer
                  type: object
                connectionString:
                  type: string
                lastBackup:
                  properties:
                    location:
                      type: string
                    size:
                      type: string
                    successful:
                      type: boolean
                    time:
                      format: date-time
                      type: string
                  required:
                    - successful
                  type: object
                mongos:
                  properties:
                    phase:
                      type: string
                    ready:
                      format: int32
                      type: integer
                    total:
                      format: int32
                      type: integer
                  type: object
                observedGeneration:
                  format: int64
                  type: integer
                phase:
                  enum:
                    - Pending
                    - Initializing
                    - Running
                    - Failed
                    - Upgrading
                  type: string
                shardedCollections:
                  items:
                    type: string
                  type: array
                shards:
                  items:
                    properties:
                      name:
                        type: string
                      phase:
                        type: string
                      primary:
                        type: string
                      ready:
                        format: int32
                        type: integer
                      total:
                        format: int32
                        type: integer
                    required:
                      - name
                      - ready
                      - total
                    type: object
                  type: array
              type: object
          type: object
      served: true
      storage: true
      subresources:
        status: {}
